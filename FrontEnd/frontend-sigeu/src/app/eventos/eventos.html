<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eventos</title>
  <link rel="stylesheet" href="eventos.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>

  <header>
    <nav class="navbar">
      <div class="nav-left">
        <a routerLink="/homeO">Inicio</a>
        <a routerLink="/eventos" class="active">Eventos</a>
        <a routerLink="/organizacionExt">Organizaciones</a>
      </div>

      <div class="nav-icons">
        <app-notificaciones></app-notificaciones>
        <a routerLink="/perfil">
        <span class="material-symbols-outlined profile-pic" id="perfil">account_circle</span></a>
      </div>
    </nav>
  </header>

  <!-- ======= MODAL DE MENSAJES ======= -->
  <div class="modal mensaje-modal" [style.display]="showMessageModal ? 'flex' : 'none'">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 [style.color]="messageType === 'success' ? '#4caf50' : '#f44336'">{{ messageTitle }}</h3>
        <span class="close" (click)="closeMessageModal()">&times;</span>
      </div>
      <div style="padding: 20px 0;">
        <p [style.color]="messageType === 'success' ? '#2e7d32' : '#c62828'">{{ messageText }}</p>
      </div>
      <div style="text-align: right;">
        <button 
          class="save-btn" 
          (click)="closeMessageModal()"
          [style.background-color]="messageType === 'success' ? '#4caf50' : '#f44336'">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- ======= CONTENIDO PRINCIPAL ======= -->
  <main class="main-container">
    <section class="event-container">
      <div class="event-header">
        <h2>Eventos</h2>
        <div class="filter-container">
          <div class="filter-select">
            <span class="material-symbols-outlined">filter_alt</span>
            <select [(ngModel)]="filtroTipo">
              <option value="nombre">Nombre</option>
              <option value="fecha">Fecha</option>
              <option value="estado">Estado</option>
            </select>
          </div>

          <input  
            type="text" 
            placeholder="Valor a buscar" 
            [(ngModel)]="valorFiltro"
          >

          <button (click)="filtrarEventos()" class="btn-filtrar">
            <span class="material-symbols-outlined">search</span>
            Filtrar
          </button>
          <button (click)="limpiarFiltro()" class="btn-limpiar">
            <span class="material-symbols-outlined">clear</span>
            Limpiar
          </button>
        </div>
          <button class="add-btn" id="addEventBtn" (click)="openModal()">+</button>
        </div>            

        <table class="event-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="eventTableBody">
          <tr *ngIf="!eventos.length">
            <td colspan="6" class="event-empty">No hay eventos registrados</td>
          </tr>
          <tr *ngFor="let e of eventosFiltrados | slice:(paginaActual - 1) * elementosPorPagina : paginaActual * elementosPorPagina">
            <td>{{ e.codigo }}</td>
            <td>{{ e.nombre }}</td>
            <td>{{ e.tipo }}</td>
            <td>{{ e.fecha }}</td>
            <td>
              <span 
                class="estado-badge"
                [ngClass]="{
                  'estado-registrado': e.estado === 'borrador',
                  'estado-revision': e.estado === 'enviado',
                  'estado-aprobado': e.estado === 'aprobado',
                  'estado-rechazado': e.estado === 'rechazado'
                }">
                {{ e.estado }}
              </span>
            </td>
            
            <!-- Columna de acciones -->
            <td>
              <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <!-- Bot√≥n Editar: solo si est√° en estado "borrador" o "rechazado" -->
                <button 
                  *ngIf="e.estado === 'borrador' || e.estado === 'rechazado'" 
                  class="small-btned" 
                  type="button" 
                  (click)="openEdit(e)"
                  title="Editar evento">
                  üñä Editar
                </button>
                
                <!-- Bot√≥n Eliminar: solo si est√° en estado "borrador" o "rechazado" -->
                <button 
                  *ngIf="e.estado === 'borrador' || e.estado === 'rechazado'" 
                  class="small-btne" 
                  type="button" 
                  (click)="eliminarEvento(e.codigo)"
                  title="Eliminar evento">
                  üóë Eliminar
                </button>
                
                <!-- Bot√≥n Enviar Revisi√≥n: solo si est√° en estado "borrador" -->
                <button 
                  *ngIf="e.estado === 'borrador'" 
                  class="small-btnen" 
                  type="button" 
                  (click)="enviarEvento(e.codigo)"
                  title="Enviar a revisi√≥n">
                  üì§ Enviar
                </button>
                
                <!-- Mostrar estado si ya fue enviado pero no evaluado -->
                <span 
                  *ngIf="e.estado === 'enviado'"
                  style="color: #ff9800; font-weight: 500; font-size: 0.85rem; padding: 5px;">
                  En revisi√≥n
                </span>
                
                <!-- Bot√≥n Ver Evaluaci√≥n: solo si fue Aprobado o Rechazado -->
                <button 
                  *ngIf="e.estado === 'aprobado' || e.estado === 'rechazado'" 
                  class="small-btn-detalles" 
                  type="button" 
                  (click)="abrirDetallesEvaluacion(e.codigo)"
                  title="Ver detalles de evaluaci√≥n">
                  üëÅ Ver Evaluaci√≥n
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pagination">
        <button (click)="paginaAnterior()" [disabled]="paginaActual === 1">Anterior</button>
        <span>P√°gina {{paginaActual}} de {{totalPaginas}}</span>
        <button (click)="paginaSiguiente()" [disabled]="paginaActual === totalPaginas">Siguiente</button>
      </div>
    </section>
  </main>
 

  <!-- ======= MODAL DE REGISTRO/EDICI√ìN ======= -->
  <div id="eventModal" class="modal" [style.display]="showModal ? 'flex' : 'none'">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ editMode ? 'Editar evento' : 'Registrar nuevo evento' }}</h3>
        <span class="close" id="closeModal" (click)="closeModal()">&times;</span>
      </div>

      <form id="eventForm" (submit)="onSubmitCrearEvento($event)">
        <div class="form-grid">
          <div class="form-group">
            <label>C√≥digo</label>
            <input class="input100" type="text" [value]="editMode ? editCodigo : 'Se asigna autom√°ticamente'" readonly>
          </div>
          
          <div class="form-group">
            <label>Nombre del evento *</label>
            <input type="text" required [(ngModel)]="nuevoEvento.nombre" name="nombre">
          </div>

          <div class="form-group">
            <label>Fecha *</label>
            <input type="date" required [(ngModel)]="nuevoEvento.fecha" name="fecha">
          </div>

          <div class="form-group">
            <label>Hora inicio *</label>
            <input type="time" required [(ngModel)]="nuevoEvento.hora_inicio" name="hora_inicio">
          </div>

          <div class="form-group">
            <label>Hora fin *</label>
            <input type="time" required [(ngModel)]="nuevoEvento.hora_fin" name="hora_fin">
          </div>
          
          <!-- Espacios -->
          <div class="form-group full-width">
            <label>Espacios *</label>
            <div id="spaceContainer">
              <div class="dynamic-group" *ngFor="let s of selectedEspacios; let i = index">
                <select class="input100" [(ngModel)]="selectedEspacios[i]" name="espacio_{{i}}" required>
                  <option [ngValue]="''">Seleccione un espacio</option>
                  <option *ngFor="let e of espaciosListado" [ngValue]="e.codigo">{{ e.nombre || e.codigo }}</option>
                </select>
                <button type="button" class="remove-btn" (click)="removeEspacio(i)">x</button>
              </div>
            </div>
            <button type="button" class="small-btn" (click)="addEspacio()">+ A√±adir espacio</button>
          </div>

          <div class="form-group full-width">
            <label>Descripci√≥n</label>
            <textarea name="descripcion" rows="4" [(ngModel)]="nuevoEvento.descripcion"></textarea>
          </div>

          <div class="form-group">
            <label>Tipo de evento *</label>
            <select [(ngModel)]="nuevoEvento.tipo" name="tipo" required>
              <option value="">Seleccione un tipo</option>
              <option value="Academico">Acad√©mico</option>
              <option value="Ludico">L√∫dico</option>
            </select>
          </div>
                          
          <!-- Organizaciones -->
          <div class="form-group full-width">
            <label>Organizaciones externas</label>
            <div id="orgContainer">
              <div class="dynamic-group" *ngFor="let org of selectedOrganizaciones; let i = index">
                <select class="input100" [(ngModel)]="selectedOrganizaciones[i].nit" name="org_{{i}}">
                  <option [ngValue]="''">Seleccione una organizaci√≥n</option>
                  <option *ngFor="let o of organizacionesListado" [ngValue]="o.nit">{{ o.nombre || o.nit }}</option>
                </select>
                <select class="input100 org-type" [(ngModel)]="selectedOrganizaciones[i].tipo" name="org_tipo_{{i}}" (change)="onOrgTipoChange(i)">
                  <option [ngValue]="'legal'">Representante legal</option>
                  <option [ngValue]="'alterno'">Responsable alterno</option>
                </select>
                <input *ngIf="selectedOrganizaciones[i].tipo === 'alterno'" class="input100 alt-name" type="text" placeholder="Nombre del alterno" [(ngModel)]="selectedOrganizaciones[i].alterno" name="org_alterno_{{i}}">
                
                <!-- Input para archivo nuevo -->
                <input type="file" accept="application/pdf" title="Aval en PDF (solo PDF)" (change)="onOrgAvalChange($event, i)">
                
                <!-- Mostrar archivo nuevo seleccionado -->
                <div *ngIf="org.avalNuevo" class="new-file">
                  <small>Nuevo archivo seleccionado</small>
                </div>
                
                <!-- Solo indicar si hay archivo existente (sin botones de acci√≥n) -->
                <div *ngIf="editMode && org.certificadoExistente" class="existing-file-info">
                  <small>‚úì Archivo existente registrado</small>
                </div>
                
                <button type="button" class="remove-btn" (click)="removeOrganizacion(i)">x</button>
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <button type="button" class="small-btn" (click)="addOrganizacion()">+ A√±adir organizaci√≥n</button>
              <button type="button" class="small-btn" (click)="openOrgInlineModal()">+ Nueva organizaci√≥n</button>
            </div>
          </div>

          <!-- Responsables -->
          <div class="form-group full-width">
            <label>Responsables *</label>
            <div id="respContainer">
              <div class="dynamic-group" *ngFor="let r of selectedResponsables; let i = index">
                <select class="input100" [(ngModel)]="selectedResponsables[i].id" name="resp_{{i}}" required>
                  <option [ngValue]="0">Seleccione un responsable</option>
                  <option *ngFor="let u of usuariosListado" [ngValue]="u.identificacion">{{ u.nombre }} {{ u.apellido }}</option>
                </select>
                
                <!-- Input para archivo nuevo -->
                <input type="file" accept="application/pdf" title="Documento de aval (solo PDF)" (change)="onRespAvalChange($event, i)">
                
                <!-- Mostrar archivo nuevo seleccionado -->
                <div *ngIf="r.avalNuevo" class="new-file">
                  <small>Nuevo archivo seleccionado</small>
                </div>
                
                <!-- Solo indicar si hay archivo existente (sin botones de acci√≥n) -->
                <div *ngIf="editMode && r.documentoExistente" class="existing-file-info">
                  <small>‚úì Documento de aval existente</small>
                </div>
                
                <button type="button" class="remove-btn" (click)="removeResponsable(i)">x</button>
              </div>
            </div>
            <button type="button" class="small-btn" (click)="addResponsable()">+ A√±adir responsable</button>
          </div>

          <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="small-btn" (click)="closeModal()" style="margin-right: 10px; background-color: #ccc;">Cancelar</button>
            <button type="submit" class="save-btn">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ======= MODAL DE NUEVA ORGANIZACI√ìN ======= -->
  <div class="modal" [style.display]="showOrgInline ? 'flex' : 'none'">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Registrar organizaci√≥n (para este evento)</h3>
        <span class="close" (click)="closeOrgInlineModal()">&times;</span>
      </div>
      <form (submit)="onSubmitOrgInline($event)">
        <div class="form-grid">
          <div class="form-group">
            <label>NIT *</label>
            <input type="text" required [(ngModel)]="orgInline.nit" name="nit">
          </div>
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" required [(ngModel)]="orgInline.nombre" name="nombre">
          </div>
          <div class="form-group">
            <label>Representante Legal *</label>
            <input type="text" required [(ngModel)]="orgInline.representante_legal" name="representante_legal">
          </div>
          <div class="form-group">
            <label>Tel√©fono *</label>
            <input type="tel" required [(ngModel)]="orgInline.telefono" name="telefono">
          </div>
          <div class="form-group">
            <label>Ubicaci√≥n *</label>
            <input type="text" required [(ngModel)]="orgInline.ubicacion" name="ubicacion">
          </div>
          <div class="form-group">
            <label>Sector Econ√≥mico *</label>
            <input type="text" required [(ngModel)]="orgInline.sector_economico" name="sector_economico">
          </div>
          <div class="form-group full-width">
            <label>Actividad Principal *</label>
            <input type="text" required [(ngModel)]="orgInline.actividad_principal" name="actividad_principal">
          </div>
        </div>
        <div style="margin-top: 20px; text-align: right;">
          <button class="small-btn" type="button" (click)="closeOrgInlineModal()" style="margin-right: 10px; background-color: #ccc;">Cancelar</button>
          <button class="save-btn" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ======= MODAL DE DETALLES DE EVALUACI√ìN ======= -->
  <div class="modal" [style.display]="showDetallesModal ? 'flex' : 'none'">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>{{ detallesEvaluacion.estado === 'aprobado' ? '‚úÖ Evento Aprobado' : '‚ùå Evento Rechazado' }}</h3>
        <span class="close" (click)="cerrarDetallesModal()">&times;</span>
      </div>
      
      <div style="padding: 20px 0;">
        <div class="detalle-item">
          <strong>Nombre del evento:</strong>
          <p>{{ detallesEvaluacion.nombre }}</p>
        </div>
        
        <div class="detalle-item">
          <strong>Estado:</strong>
          <p [style.color]="detallesEvaluacion.estado === 'aprobado' ? '#4caf50' : '#f44336'">
            {{ detallesEvaluacion.estado | uppercase }}
          </p>
        </div>
        
        <div class="detalle-item" *ngIf="detallesEvaluacion.evaluadoPor">
          <strong>Evaluado por:</strong>
          <p>{{ detallesEvaluacion.evaluadoPor }}</p>
        </div>
        
        <div class="detalle-item" *ngIf="detallesEvaluacion.estado === 'rechazado'">
          <strong>Motivo del rechazo:</strong>
          <p style="background-color: #ffebee; padding: 10px; border-radius: 6px; color: #c62828;">
            {{ detallesEvaluacion.observaciones || 'No se proporcionaron observaciones' }}
          </p>
        </div>
        
        <div class="detalle-item" *ngIf="detallesEvaluacion.estado === 'aprobado'">
          <strong>Mensaje:</strong>
          <p style="background-color: #e8f5e9; padding: 10px; border-radius: 6px; color: #2e7d32;">
            Su evento ha sido aprobado exitosamente por la Secretar√≠a Acad√©mica. 
            Puede proceder con la organizaci√≥n del mismo seg√∫n la fecha programada.
          </p>
        </div>
        
        <div class="detalle-item" *ngIf="detallesEvaluacion.actaComite && detallesEvaluacion.estado === 'aprobado'">
          <strong>Acta del comit√©:</strong>
          <button class="small-btn" (click)="descargarActaComite()" style="margin-top: 5px;">
            üìÑ Descargar Acta
          </button>
        </div>
      </div>
      
      <div style="text-align: right; margin-top: 20px;">
        <button 
          class="save-btn" 
          (click)="cerrarDetallesModal()"
          [style.background-color]="detallesEvaluacion.estado === 'aprobado' ? '#4caf50' : '#f44336'">
          Cerrar
        </button>
      </div>
    </div>
  </div>

</body>
</html>